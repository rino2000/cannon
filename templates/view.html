<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cannon</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      table {
        border-collapse: collapse;
      }
      td {
        border: 1px solid black;
        width: 30px;
        height: 30px;
        text-align: center;
        cursor: pointer;
      }
      #board {
        margin-top: 20px;
      }
      .info {
        margin: 10px 0;
        color: red;
      }
    </style>
  </head>
  <body>
    <h1>Cannon</h1>

    <label>Room name: <input type="text" id="roomInput" /> </label>
    <button id="joinBtn">Join Room</button>

    <p id="info"></p>
    <label id="playerColor"></label>
    <table id="board"></table>

    <script>
      const socket = io("http://127.0.0.1:8000", {
        transports: ["polling"],
      });

      let room = "";
      let field = [];
      const maxSoldiers = 15;
      let player = 0;
      let players = [];

      const boardEl = document.getElementById("board");
      const infoEl = document.getElementById("info");

      // Join Room with roomname
      document.getElementById("joinBtn").addEventListener("click", () => {
        const roomInput = document.getElementById("roomInput").value.trim();
        if (!roomInput) return alert("Enter a room name!");
        room = roomInput;
        socket.emit("join_room", { room });
      });

      function drawField() {
        boardEl.innerHTML = "";
        field.forEach((row, i) => {
          const tr = document.createElement("tr");
          row.forEach((cell, j) => {
            const td = document.createElement("td");
            td.innerHTML = cell;
            td.addEventListener("click", () => handleCellClick(i, j));
            tr.appendChild(td);
          });
          boardEl.appendChild(tr);
        });
      }

      // --- Handle cell click ---
      function handleCellClick(x, y) {
        field[x][y] = player === 0 ? "ðŸ‘‡ðŸ»" : "ðŸ‘†ðŸ¿";
        drawField();
        console.log(x, y);
        socket.emit('place_soldaten', x, y, player, room);
      }

      // Send update to server
      const soldiersCoords = [];
      const townCoord = [];
      field.forEach((row, i) => {
        row.forEach((cell, j) => {
          if (cell === "ðŸ‘‡ðŸ»" || cell === "ðŸ‘†ðŸ¿") soldiersCoords.push([i, j]);
          if (cell === "ðŸ " || cell === "ðŸ¡") townCoord.push([i, j]);
        });
      });

      // --- Socket events ---
      socket.on("joined_room", (data) => {
        console.log(data);

        if (players.length != 2) {
          infoEl.innerHTML = "Wait for second player to join";
        } else {
          infoEl.innerHTML = "Start game";
        }

        field = data.room.field;
        player = data.room.colors[data.player];
        players.push(data.player);

        infoEl.innerText = `Joined room: ${room}`;
        document.getElementById("playerColor").innerHTML =
          "You are player: " + (player === 0 ? "White" : "Black");
        drawField();
      });

      console.log(field);

      socket.on("place_soldaten", (coordinate) => {
        console.log(coordinate);
        drawField();
      });

      socket.on("update_field", (newField) => {
        field = newField;
        console.log(newField);
        
        drawField();
      });

      socket.on("player_assignment", (data) => {
        playerColor = data.spieler;
      });

      socket.on("error", (data) => {
        infoEl.innerText = "Error: " + data.message;
      });

      socket.on("waiting", (data) => {
        infoEl.innerText = "Waiting" + data.message;
      });

      socket.on("player_left", (data) => {
        infoEl.innerText = `Player left: ${data.sid}`;
      });

      socket.on("connect_error", (err) => {
        console.error("CONNECT ERROR", err);
      });
    </script>
  </body>
</html>
