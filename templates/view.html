<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cannon</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      table {
        border-collapse: collapse;
      }
      td {
        border: 1px solid black;
        width: 30px;
        height: 30px;
        text-align: center;
        cursor: pointer;
      }
      #board {
        margin-top: 20px;
      }
      .info {
        margin: 10px 0;
        color: red;
      }
    </style>
  </head>
  <body>
    <h1>Cannon</h1>

    <label>Room name: <input type="text" id="roomInput" /> </label>
    <button id="joinBtn">Join Room</button>

    <p id="info"></p>
    <p id="playerColor"></p>
    <p id="playerPlaceSoldatenLeft"></p>
    <table id="board"></table>

    <script>
      const socket = io("http://127.0.0.1:8000", {
        transports: ["polling"],
      });

      let room = "";
      let field = [];
      let maxSoldiersWhite = 15;
      let maxSoldiersBlack = 15;
      let player = 0;
      let players = [];
      const soldatenWhite = "ðŸ‘‡ðŸ»";
      const soldatenBlack = "ðŸ‘†ðŸ¿";

      const boardEl = document.getElementById("board");
      const infoEl = document.getElementById("info");
      const playerPlaceSoldatenLeft = document.getElementById(
        "playerPlaceSoldatenLeft",
      );

      // Join Room with roomname
      document.getElementById("joinBtn").addEventListener("click", () => {
        const roomInput = document.getElementById("roomInput").value.trim();
        if (!roomInput) return alert("Enter a room name!");
        room = roomInput;
        roomInput.innerHTML = "";
        socket.emit("join_room", { room });
      });

      const letters = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k"];

      function drawField() {
        boardEl.innerHTML = "";

        // Draw grid rows
        field.forEach((row, i) => {
          const tr = document.createElement("tr");

          // Row number (0â€“9)
          const label = document.createElement("td");
          label.textContent = i;
          label.style.fontWeight = "bold";
          tr.appendChild(label);

          row.forEach((cell, j) => {
            const td = document.createElement("td");
            td.textContent = cell === 0 ? "" : cell;
            td.addEventListener("click", () => handleCellClick(i, j));
            tr.appendChild(td);
          });

          boardEl.appendChild(tr);
        });

        const footer = document.createElement("tr");
        footer.appendChild(document.createElement("td"));

        letters.forEach((letter) => {
          const td = document.createElement("td");
          td.textContent = letter;
          td.style.fontWeight = "bold";
          footer.appendChild(td);
        });

        boardEl.appendChild(footer);
      }

      function soldiersLeft() {
        if (maxSoldiersBlack === 0 || maxSoldiersWhite === 0) {
          playerPlaceSoldatenLeft.innerHTML = "Max Soldaten geplaced";
          return;
        }

        const isWhite = player === 0;
        const soldiersLeft = isWhite ? --maxSoldiersWhite : --maxSoldiersBlack;

        playerPlaceSoldatenLeft.innerHTML = `You have ${soldiersLeft} Soldaten left to place`;
      }

      const soldatenPlacedSameCoordinate = (x, y, soldat) =>
        field[x][y] === soldat;

      function handleCellClick(x, y) {
        if (
          soldatenPlacedSameCoordinate(
            x,
            y,
            player === 0 ? soldatenWhite : soldatenBlack,
          ) ||
          maxSoldiersBlack === 0 ||
          maxSoldiersWhite === 0
        ) {
          return;
        }

        field[x][y] = player === 0 ? soldatenWhite : soldatenBlack;
        drawField();
        soldiersLeft();
        socket.emit("place_soldaten", x, y, player, room);
      }

      const soldiersCoords = [];
      const townCoord = [];
      field.forEach((row, i) => {
        row.forEach((cell, j) => {
          if (cell === "ðŸ‘‡ðŸ»" || cell === "ðŸ‘†ðŸ¿") soldiersCoords.push([i, j]);
          if (cell === "ðŸ " || cell === "ðŸ¡") townCoord.push([i, j]);
        });
      });

      socket.on("joined_room", (data) => {
        playerPlaceSoldatenLeft.innerHTML =
          "You have 15 Soldaten left to place";

        field = data.room.field;
        playerColor = data.room.players[data.player];
        player = playerColor;
        players.push(data.room.player);

        infoEl.innerText = `Joined room: ${room}`;
        document.getElementById("playerColor").innerHTML =
          "You are player: " + (player === 0 ? "White" : "Black");
        drawField();
      });

      socket.on("update_field", (newField) => {
        field = newField;
        drawField();
      });

      socket.on("player_assignment", (data) => {
        playerColor = data.spieler;
      });

      socket.on("error", (data) => {
        infoEl.innerText = "Error: " + data.message;
      });

      socket.on("player_left", (data) => {
        infoEl.innerText = `Player left: ${data.sid}`;
      });

      socket.on("connect_error", (err) => {
        console.error("CONNECT ERROR", err);
      });
    </script>
  </body>
</html>
